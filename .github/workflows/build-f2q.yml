name: build not-kernel CI variant f2q

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-kernel:
    runs-on: ubuntu-latest

    env:
      DEVICE: f2q
      DEVICE_NAME: Galaxy Z Fold2 5G
      KERNEL_NAME: not_kernel

    steps:
      - name: Check Out
        uses: actions/checkout@v3

      - name: Set Timezone
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: "America/Sao_Paulo"

      - name: Setting up the environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential flex libelf-dev \
            libssl-dev libncurses-dev python3 zstd \
            clang-14 lld-14 llvm-14 \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi
          
          sudo ln -sf /usr/bin/clang-14    /usr/local/bin/clang
          sudo ln -sf /usr/bin/ld.lld-14   /usr/local/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-ar-14  /usr/local/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-14  /usr/local/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-objcopy-14  /usr/local/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-objdump-14  /usr/local/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-strip-14    /usr/local/bin/llvm-strip

      - name: Install mkdtboimg
        run: |
          # -o 없이 stdout으로 받아서 base64 디코딩
          curl -s \
            "https://android.googlesource.com/platform/system/libufdt/+/refs/heads/master/utils/src/mkdtboimg.py?format=TEXT" \
            | base64 -d > /usr/local/bin/mkdtboimg
          chmod +x /usr/local/bin/mkdtboimg
          # 정상 설치 확인
          head -1 /usr/local/bin/mkdtboimg   # #!/usr/bin/env python3 이 나와야 함

      - name: Setup magiskboot
        run: |
          curl -Lo magiskboot \
            "https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk"
          # apk는 zip이라 안에서 magiskboot만 추출
          unzip -o magiskboot -d magisk_tmp 'lib/x86_64/libmagiskboot.so'
          cp magisk_tmp/lib/x86_64/libmagiskboot.so /usr/local/bin/magiskboot
          chmod +x /usr/local/bin/magiskboot

      - name: Install avbtool
        run: |
          # raw 파일 직접 다운로드
          curl -Lo /usr/local/bin/avbtool \
            "https://raw.githubusercontent.com/LineageOS/android_external_avb/refs/heads/lineage-23.2/avbtool.py"
          sudo chmod +x /usr/local/bin/avbtool
          avbtool version

      - name: Set Build Start Time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Run build script
        run: |
          chmod +x ./build-f2q.sh
          ./build-f2q.sh

      - name: Set Build End Time
        run: echo "END_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Calculate Build Duration
        run: |
          duration=$((END_TIME - START_TIME))
          minutes=$((duration / 60))
          seconds=$((duration % 60))
          echo "BUILD_DURATION=${minutes}m ${seconds}s" >> $GITHUB_ENV

      - name: Generate Build Info
        id: build_info
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Upload to Telegram
        run: |
          printf " Localversion: $(cat out/include/config/kernel.release)
           | Clang version: AOSP Clang 18.0.1
           | Build Date: $(date +'%d %B %Y')
           | Build commit hash: ${{ env.SHORT_SHA }}
           | SusFS version: v2.0.0
           | KernelSU version: 33333
           | SELinux: Enforcing" >> buildDetails.txt
          
          buildDetails="$(cat buildDetails.txt)"
          zip_file=$(ls not-CI-*.zip | head -n 1)
          
          msg="*not\\-kernel* CI build for the *Galaxy Z Fold2 5G \\(f2q\\)*
          * *
          \`\`\`
          $buildDetails
          \`\`\`
          * * Duration: ${{ env.BUILD_DURATION }}"
          
          curl -s -F document=@"$zip_file" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
          -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -F "disable_web_page_preview=true" \
          -F "parse_mode=markdownv2" \
          -F caption="$msg"

      - name: Send to GH Releases
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') != true # 태그 트리거가 아니어도 동작하게 설정 (필요시 조정)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: not-CI-*.zip
          name: "not-kernel CI: ${{ env.BUILD_DATE }} - ${{ env.SHORT_SHA }}"
          tag_name: "build-${{ github.run_id }}"
          body: |
            Automated CI Build for ${{ env.DEVICE_NAME }} (${{ env.DEVICE }})
            
            **Build Info**
            - Date: ${{ env.BUILD_DATE }}
            - Commit: ${{ env.SHORT_SHA }}
            - Duration: ${{ env.BUILD_DURATION }}
            
            **Details**
            Please check the Telegram message for detailed version info.
