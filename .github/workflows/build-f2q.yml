name: build not-kernel CI variant f2q

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      region:
        description: 'Region variant'
        required: true
        default: 'EUR_OPEN'
        type: choice
        options:
          - EUR_OPEN
          - USA_SINGLE
          - KOR_SINGLE
          - JPN_SINGLE

      selinux:
        description: 'SELinux variant'
        required: true
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-kernel:
    runs-on: ubuntu-latest

    env:
      DEVICE: f2q
      DEVICE_NAME: Galaxy Z Fold2 5G
      KERNEL_NAME: not_kernel

    steps:
      - name: Check Out
        uses: actions/checkout@v3

      - name: Set Timezone
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: "America/Sao_Paulo"

      - name: Setting up the environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential flex libelf-dev \
            libssl-dev libncurses-dev python3 zstd \
            clang-14 lld-14 llvm-14 \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi
          
          sudo ln -sf /usr/bin/clang-14    /usr/local/bin/clang
          sudo ln -sf /usr/bin/ld.lld-14   /usr/local/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-ar-14  /usr/local/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-14  /usr/local/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-objcopy-14  /usr/local/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-objdump-14  /usr/local/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-strip-14    /usr/local/bin/llvm-strip

      - name: Install mkdtboimg
        run: |
          curl -s \
            "https://android.googlesource.com/platform/system/libufdt/+/refs/heads/master/utils/src/mkdtboimg.py?format=TEXT" \
            | base64 -d > /usr/local/bin/mkdtboimg
          chmod +x /usr/local/bin/mkdtboimg
          head -1 /usr/local/bin/mkdtboimg   # #!/usr/bin/env python3 이 나와야 함

      - name: Setup magiskboot
        run: |
          curl -Lo magiskboot \
            "https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk"
          unzip -o magiskboot -d magisk_tmp 'lib/x86_64/libmagiskboot.so'
          cp magisk_tmp/lib/x86_64/libmagiskboot.so /usr/local/bin/magiskboot
          chmod +x /usr/local/bin/magiskboot

      - name: Install avbtool
        run: |
          curl -Lo /usr/local/bin/avbtool \
            "https://raw.githubusercontent.com/LineageOS/android_external_avb/refs/heads/lineage-23.2/avbtool.py"
          sudo chmod +x /usr/local/bin/avbtool
          avbtool version

      - name: Apply region config
        run: |
          REGION="${{ github.event.inputs.region }}"
          CONFIG="arch/arm64/configs/vendor/samsung/f2q.config"

          sed -i '/^CONFIG_MACH_F2Q_/d' $CONFIG
          sed -i '/^# CONFIG_MACH_F2Q_/d' $CONFIG

          echo "CONFIG_MACH_F2Q_${REGION}=y" >> $CONFIG

          echo "Applied region: $REGION"
          grep "MACH_F2Q" $CONFIG

      - name: Apply selinux config
        run: |
          SELINUX="${{ github.event.inputs.selinux }}"

          if [ "$SELINUX" = "false" ]; then
            echo "Searching for the target file..."
            TARGET_FILE=$(grep -rl "#define selinux_enforcing_boot 1" security/ || true)
            if [ -n "$TARGET_FILE" ]; then
              echo "Target file found: $TARGET_FILE"
              
              perl -0777 -pi -e 's/#define\s+selinux_enforcing_boot\s+1/#define selinux_enforcing_boot 0/gs' "$TARGET_FILE"
              
              echo "Patch applied successfully in $TARGET_FILE!"
              grep -A 2 -B 2 "selinux_enforcing_boot 0" "$TARGET_FILE" || true
            else
              echo "Error: Target file not found. Check the grep search path."
            fi
          fi

      - name: Set Build Start Time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Run build script
        run: |
          chmod +x ./build-f2q.sh
          ./build-f2q.sh

      - name: Set Build End Time
        run: echo "END_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Calculate Build Duration
        run: |
          duration=$((END_TIME - START_TIME))
          minutes=$((duration / 60))
          seconds=$((duration % 60))
          echo "BUILD_DURATION=${minutes}m ${seconds}s" >> $GITHUB_ENV

      - name: Generate Build Info
        id: build_info
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Upload to Telegram
        run: |
          printf " Localversion: $(cat out/include/config/kernel.release)
           | Clang version: AOSP Clang 18.0.1
           | Build Date: $(date +'%d %B %Y')
           | Build commit hash: ${{ env.SHORT_SHA }}
           | SusFS version: v2.0.0
           | KernelSU version: 33333
           | SELinux: Enforcing" >> buildDetails.txt
          
          buildDetails="$(cat buildDetails.txt)"
          zip_file=$(ls not-CI-*.zip | head -n 1)
          
          msg="*not\\-kernel* CI build for the *Galaxy Z Fold2 5G \\(f2q\\)*
          * *
          \`\`\`
          $buildDetails
          \`\`\`
          * * Duration: ${{ env.BUILD_DURATION }}"
          
          curl -s -F document=@"$zip_file" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
          -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -F "disable_web_page_preview=true" \
          -F "parse_mode=markdownv2" \
          -F caption="$msg"

      - name: Send to GH Releases
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') != true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: not-CI-*.zip
          name: "not-kernel CI: ${{ env.BUILD_DATE }} - ${{ env.SHORT_SHA }}"
          tag_name: "build-${{ github.run_id }}"
          body: |
            Automated CI Build for ${{ env.DEVICE_NAME }} (${{ env.DEVICE }})
            
            **Build Info**
            - Date: ${{ env.BUILD_DATE }}
            - Commit: ${{ env.SHORT_SHA }}
            - Duration: ${{ env.BUILD_DURATION }}
            
            **Details**
            Please check the Telegram message for detailed version info.
```
